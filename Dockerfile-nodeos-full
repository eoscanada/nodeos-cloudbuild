ARG BUILD_ENV=v7

# FROM gcr.io/eoscanada-public/eosio-build-env:$BUILD_ENV as builder
FROM eosio/builder:v1.1.0 as builder

ARG BRANCH
ARG REPOSITORY=https://github.com/eosio/eos.git
# Alternate repo: https://github.com/EOS-Mainnet/eos.git

COPY patches /patches

RUN true \
    && git clone -b $BRANCH --depth 1 $REPOSITORY --recursive \
    && cd eos \
    && patch -p1 < /patches/history_export.patch \
    && patch -p1 < /patches/cpu_fix.patch \
    && cmake -H. -B"/tmp/build" -GNinja \
       -DCORE_SYMBOL_NAME=EOS \
       -DWASM_ROOT=/opt/wasm \
       -DCMAKE_BUILD_TYPE=Release \
       -DCMAKE_CXX_COMPILER=clang++ \
       -DCMAKE_C_COMPILER=clang \
       -DBUILD_MONGO_DB_PLUGIN=true \
       -DCMAKE_INSTALL_PREFIX=/opt/eos \
       -DSecp256k1_ROOT_DIR=/usr/local \
    && cp --remove-destination `readlink /usr/lib/x86_64-linux-gnu/libz.so` /usr/lib/x86_64-linux-gnu/libz.so \
    && cp --remove-destination `readlink /usr/lib/x86_64-linux-gnu/libbz2.so` /usr/lib/x86_64-linux-gnu/libbz2.so \
    && cmake --build /tmp/build --target install \
    && echo $REPOSITORY ref $BRANCH revision `git describe --always --long` > /opt/eos/bin/eosio_revision

ENV LD_LIBRARY_PATH /usr/local/lib
ENV BOOST /usr/local/include
ENV INSTALL_PREFIX /opt/eos
ENV PREFIX /opt
ENV EOSIO_ROOT=/opt/eosio
